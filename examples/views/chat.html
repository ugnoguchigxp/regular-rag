<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Regular-RAG Demo</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      padding: 16px 24px;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header h1 { font-size: 1.25rem; font-weight: 600; }
    header span {
      font-size: 0.8rem;
      color: #94a3b8;
      background: #1e293b;
      padding: 2px 8px;
      border-radius: 4px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .msg {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.6;
      font-size: 0.95rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.assistant {
      align-self: flex-start;
      background: #1e293b;
      border: 1px solid #334155;
      border-bottom-left-radius: 4px;
    }
    .msg.error { background: #7f1d1d; border-color: #991b1b; }
    .rag-info {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #334155;
    }
    .rag-info summary { cursor: pointer; color: #94a3b8; }
    #input-area {
      background: #1e293b;
      border-top: 1px solid #334155;
      padding: 16px 24px;
      display: flex;
      gap: 12px;
    }
    #input-area textarea {
      flex: 1;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 12px;
      font-size: 0.95rem;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      font-family: inherit;
    }
    #input-area textarea:focus { outline: none; border-color: #3b82f6; }
    #input-area button {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0 24px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #input-area button:disabled { opacity: 0.5; cursor: not-allowed; }
    #input-area button:hover:not(:disabled) { opacity: 0.9; }
    .typing { color: #94a3b8; font-style: italic; }
  </style>
</head>
<body>
  <header>
    <h1>üí¨ Regular-RAG Demo</h1>
    <span>pgvector + ÂÖ®ÊñáÊ§úÁ¥¢ + Knowledge Graph</span>
  </header>
  <div id="chat"></div>
  <div id="input-area">
    <textarea id="msg" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." rows="1"></textarea>
    <button id="send" onclick="sendMsg()">ÈÄÅ‰ø°</button>
  </div>
  <script>
    const chatEl = document.getElementById('chat');
    const msgEl = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const history = [];

    msgEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
    });
    msgEl.addEventListener('input', () => {
      msgEl.style.height = 'auto';
      msgEl.style.height = `${Math.min(msgEl.scrollHeight, 120)}px`;
    });

    function addMsg(role, content, ragInfo) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = content;
      if (ragInfo?.results && ragInfo.results.length > 0) {
        const details = document.createElement('details');
        details.className = 'rag-info';
        details.innerHTML =
          '<summary>üìÑ RAG Sources (' + ragInfo.results.length + ')</summary>' +
          ragInfo.results.map((r, i) =>
            '<div style="margin-top:4px"><strong>' + (i + 1) + '.</strong> ' +
            r.path + ' <em>(score: ' + r.combinedScore.toFixed(3) + ')</em></div>'
          ).join('');
        div.appendChild(details);
      }
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function sendMsg() {
      const text = msgEl.value.trim();
      if (!text) return;
      msgEl.value = '';
      msgEl.style.height = 'auto';
      addMsg('user', text);
      history.push({ role: 'user', content: text });
      sendBtn.disabled = true;

      const typingEl = document.createElement('div');
      typingEl.className = 'msg assistant typing';
      typingEl.textContent = 'ËÄÉ„Åà‰∏≠...';
      chatEl.appendChild(typingEl);
      chatEl.scrollTop = chatEl.scrollHeight;

      try {
        const res = await fetch('/api/rag', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: history }),
        });
        const data = await res.json();
        typingEl.remove();
        if (data.error) {
          addMsg('error', `Error: ${data.error}`);
        } else {
          const content = data.content || '(empty response)';
          addMsg('assistant', content, data.rag);
          history.push({ role: 'assistant', content });
        }
      } catch (err) {
        typingEl.remove();
        addMsg('error', `Network error: ${err.message}`);
      }
      sendBtn.disabled = false;
      msgEl.focus();
    }
  </script>
</body>
</html>
